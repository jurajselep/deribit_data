<main class="app">
  <header class="app__header">
    <div class="app__header-left">
      <h1>Digital Options Chain</h1>

      <div class="app__selectors">
        <label class="app__selector">
          <span>Currency</span>
          <select [value]="selectedCurrency()" (change)="changeCurrency($any($event.target).value)">
            <option *ngFor="let currency of currencies" [value]="currency.value">
              {{ currency.label }}
            </option>
          </select>
        </label>
        <label class="app__selector">
          <span>Instrument</span>
          <select
            [value]="selectedInstrument() ?? ''"
            (change)="changeInstrument($any($event.target).value)"
          >
            <option value="" disabled>Select instrument</option>
            <option *ngFor="let instrument of instruments()" [value]="instrument.instrument_name">
              {{ instrument.instrument_name }}
            </option>
          </select>
        </label>
      </div>
      <div class="app__selector-status" *ngIf="instrumentsLoading()">Loading instruments…</div>
      <div class="app__selector-status app__selector-status--error" *ngIf="instrumentsError()">
        {{ instrumentsError() }}
      </div>
      <div class="app__selector-status" *ngIf="instrumentSummaryLoading()">Loading instrument data…</div>
      <div class="app__selector-status app__selector-status--error" *ngIf="instrumentSummaryError()">
        {{ instrumentSummaryError() }}
      </div>

      <ng-container *ngIf="selectedChain() as chain; else placeholderMeta">
        <div class="app__maturities" role="tablist">
          <button
            *ngFor="let maturity of maturities()"
            type="button"
            role="tab"
            class="app__maturity"
            [class.app__maturity--active]="maturity.id === selectedMaturity()"
            (click)="selectMaturity(maturity.id)"
          >
            {{ maturity.label }}
          </button>
        </div>

        <p class="app__meta">
          Underlying {{ chain.summary.underlyingText }} · ATM IV {{ chain.summary.atmIVText }} · Skew
          {{ chain.summary.skewText }}
        </p>

        <div class="app__volatility-layout">
          <div class="app__smile" role="img" aria-label="volatility smile chart">
            <div class="app__smile-y-axis">
              <span>{{ smileAxis().maxIv }}</span>
              <span class="app__smile-y-label">IV (%)</span>
              <span>{{ smileAxis().minIv }}</span>
            </div>
          <svg viewBox="0 0 600 160" preserveAspectRatio="none">
            <ng-container *ngFor="let series of smileSeries()">
              <g *ngIf="series.points.length > 0 && (!smileFilter() || smileFilter() === series.maturity)">
                <polyline
                  [attr.points]="series.path"
                  fill="none"
                  [attr.stroke]="series.color"
                  [attr.stroke-width]="smileFilter() ? 3.5 : series.isSelected ? 3.5 : 2"
                  stroke-linecap="round"
                  [attr.opacity]="smileFilter() ? 0.95 : series.isSelected ? 0.95 : 0.65"
                ></polyline>
                <g *ngFor="let point of series.points">
                  <circle
                    [attr.cx]="point.x"
                    [attr.cy]="point.y"
                    [attr.r]="smileFilter() ? 3.5 : series.isSelected ? 3.5 : 2.5"
                    [attr.fill]="series.color"
                    [attr.opacity]="smileFilter() ? 0.95 : series.isSelected ? 0.9 : 0.5"
                  ></circle>
                </g>
              </g>
            </ng-container>
          </svg>
          <div class="app__smile-axis">
            <span>{{ smileAxis().minStrike }}</span>
            <span>Strike</span>
            <span>{{ smileAxis().maxStrike }}</span>
          </div>
          <div class="app__smile-legend" *ngIf="smileSeries().length > 0">
            <button
              type="button"
              *ngFor="let series of smileSeries()"
              class="app__smile-legend-item"
              [class.app__smile-legend-item--active]="series.isSelected"
              [class.app__smile-legend-item--filtered]="smileFilter() === series.maturity"
              [disabled]="series.points.length === 0"
              [attr.aria-pressed]="smileFilter() === series.maturity"
              (click)="toggleSmileFilter(series.maturity)"
            >
              <span class="app__smile-legend-swatch" [style.background-color]="series.color"></span>
              {{ series.label }}
            </button>
          </div>
          </div>

          <div class="app__surface" *ngIf="volSurface() as surface; else surfacePlaceholder">
            <div class="app__surface-header">
              <span>Volatility Surface</span>
              <span>
                {{ surface.maturityLabels.length }} maturities · {{ surface.strikeLabels.length }} strikes ·
                {{ surface.pointCount }} pts
              </span>
            </div>
            <div class="app__surface-canvas-wrapper">
              <canvas #volSurfaceCanvas class="app__surface-canvas"></canvas>
            </div>
            <div class="app__surface-axis">
              <span>Strikes</span>
              <span>Implied Vol</span>
              <span>Maturities</span>
            </div>
          </div>
        </div>
        <ng-template #surfacePlaceholder>
          <div class="app__surface app__surface--empty">
            <span class="app__surface-empty">Insufficient option data to render a volatility surface.</span>
          </div>
        </ng-template>

      </ng-container>
      <ng-template #placeholderMeta>
        <p class="app__meta app__meta--empty">Awaiting market data…</p>
      </ng-template>

      <div class="app__history">
        <span class="app__metric-label">Recent updates (ms)</span>
        <span class="app__history-values">
          {{ frameStatsView().recentDurationsText || 'n/a' }}
        </span>
      </div>
    </div>

    <div class="app__actions">
      <span class="app__timestamp">
        Last update:
        <ng-container *ngIf="selectedChain() as chain; else dash">{{ chain.summary.lastUpdatedText }}</ng-container>
        <ng-template #dash>--:--:--</ng-template>
      </span>
    </div>
  </header>

  <section class="app__table">
    <ng-container *ngIf="selectedChain() as chain; else emptyTable">
      <table>
        <thead>
          <tr class="app__table-group">
            <th colspan="4">Calls</th>
            <th class="app__table-divider">Strike</th>
            <th colspan="4">Puts</th>
          </tr>
          <tr>
            <th>Bid</th>
            <th>Ask</th>
            <th>IV</th>
            <th>Δ</th>
            <th>Strike</th>
            <th>Δ</th>
            <th>IV</th>
            <th>Bid</th>
            <th>Ask</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let row of chain.rows; trackBy: trackByStrike"
            [ngClass]="{ up: row.call.change >= 0, down: row.call.change < 0 }"
          >
            <td>{{ row.call.bidText }}</td>
            <td>{{ row.call.askText }}</td>
            <td>{{ row.call.ivText }}</td>
            <td>{{ row.call.deltaText }}</td>
            <td class="app__strike">{{ row.strikeText }}</td>
            <td>{{ row.put.deltaText }}</td>
            <td>{{ row.put.ivText }}</td>
            <td>{{ row.put.bidText }}</td>
            <td>{{ row.put.askText }}</td>
          </tr>
        </tbody>
      </table>
    </ng-container>
    <ng-template #emptyTable>
      <div class="app__empty">No option data available.</div>
    </ng-template>
  </section>

  <footer class="app__footer">
    <div class="app__loop-controls">
      <button type="button" (click)="startLoop()" [disabled]="loopRunning()">Start loop</button>
      <button type="button" class="button--stop" (click)="stopLoop()" [disabled]="!loopRunning()">Stop loop</button>
      <button type="button" (click)="refreshOnce()">Refresh snapshot</button>
    </div>
    <div class="app__metrics">
      <div class="app__metric">
        <span class="app__metric-label">Frame spacing</span>
        <span class="app__metric-value">{{ frameStatsView().lastFrameSpacingText }} · {{ frameStatsView().instantFpsText }}</span>
      </div>
      <div class="app__metric">
        <span class="app__metric-label">Perf</span>
        <span class="app__metric-value">
          {{ frameStatsView().lastDurationText }} total · smile {{ frameStatsView().lastSmileDurationText }} · data
          {{ frameStatsView().lastDataDurationText }} · signals {{ frameStatsView().lastSignalDurationText }} · stats
          {{ frameStatsView().lastStatsDurationText }}
        </span>
      </div>
      <div class="app__metric app__metric--status">
        <span class="app__metric-label">Avg update</span>
        <span
          class="app__metric-value"
          [class.app__metric-value--good]="frameStatsView().meets60"
          [class.app__metric-value--cold]="!frameStatsView().meets60 && frameStatsView().sampleCount >= 10"
        >
          {{ frameStatsView().averageDurationText }} · 60 fps?
          <strong>{{ frameStatsView().statusText }}</strong>
        </span>
      </div>
    </div>
  </footer>
</main>
